<!DOCTYPE html>
<html lang="zh-tw" style="background-color: #f0f2f5">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fat4Fun-訂單查詢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
          rel="stylesheet" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../Content/NavFooter.css" />
    <script src="../Scripts/vue.global.js"></script>

    <style>
        body,
        main {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            color: #333; /* 文字色調較深 */
        }

        h1,
        h3 {
            color: #4a4a4a; /* 標題用較深灰色 */
        }

        .nav-tabs .nav-link {
            color: #6c757d; /* 頁籤文字色 */
            background-color: #e9ecef;
        }

            .nav-tabs .nav-link.active {
                color: #fff;
                background-color: #007bff; /* 藍色主題 */
            }

        .table {
            border-collapse: collapse; /* 避免雙重邊框 */
        }

            .table td {
                min-height: 50px; /* 調整這裡的高度值 */
            }

            .table th,
            .table td {
                color: #333;
                padding: 12px 15px;
                border: 2px solid #ddd; /* 添加邊框 */
                vertical-align: middle; /* 垂直置中 */
            }

            .table thead th {
                background-color: #f8f9fa; /* 淺灰色背景 */
                color: #333;
                font-weight: bold;
            }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #f2f2f2; /* 偶數行的背景顏色 */
        }

        /* 按鈕顏色設定 */
        .btn-link {
            color: #007bff; /* 設定連結按鈕顏色 */
            text-decoration: none;
        }

            .btn-link:hover {
                color: #0056b3;
                text-decoration: underline;
            }

        .progress-bar {
            color: white; /* 進度條內的文字白色 */
        }

        /* 美化的分隔線 */
        hr {
            background-color: #007bff;
            height: 3px;
            border: none;
        }

        .accordion-body {
            background-color: #f9fafb;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        /* 主背景顏色 */
        main {
            background-color: #ffffff; /* 主要區域的背景設置為白色 */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 加陰影效果 */
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
        }

        /* 調整按鈕樣式 */
        .btn-primary {
            background-color: #28a745;
            border-color: #28a745;
        }

            .btn-primary:hover {
                background-color: #218838;
                border-color: #1e7e34;
            }
    </style>
</head>

<body>
    <div id="app">
        <header-component></header-component>
        <main>
            <div class="container py-5" style="margin-top: 140px">
                <h1 class="text-dark mb-5">訂單查詢</h1>
                <ul class="nav nav-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="Order.html">訂單查詢</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="track.html">追蹤訂單</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="EditProfile.html">修改資料及密碼</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="QA.html">Q&A</a>
                    </li>
                </ul>

                <section class="mt-4">
                    <!-- 未完成訂單start -->
                    <div>
                        <h3 class="mt-4">未完成訂單</h3>
                        <div class="accordion accordion-menu" id="accordionExample">
                            <table v-for="order in filteredOrders" class="table table-striped">
                                <thead>
                                    <tr class="text-center">
                                        <th>訂單編號</th>
                                        <th>日期</th>
                                        <th>訂單狀態</th>
                                        <th>總價</th>
                                        <th>發票</th>
                                        <th>付款方式</th>
                                        <th>退貨</th>
                                        <th>備註</th>
                                    </tr>
                                </thead>
                                <tbody >
                                    <tr :key="order.id" class="text-center">
                                        <td>
                                            <a class="btn btn-link" data-bs-toggle="collapse" :href="'#order' + order.id" role="button" aria-expanded="false" :aria-controls="'order' + order.id">
                                                {{ order.no }}
                                            </a>
                                        </td>
                                        <td>{{ formatDate(order.createDate)}}</td>
                                        <td>{{ getOrderStatus(order.status) }}</td>
                                        <td>
                                            $ {{formatCurrency(order.totalAmount)}}
                                        </td>
                                        <td>電子發票</td>
                                        <td>{{ getPaymentMethod(order.paymentMethod) }}</td>
                                        <td>7天內可退貨</td>
                                        <td>無</td>
                                    </tr>
                                    <tr >
                                        <td colspan="8">
                                            <div class="progress mt-2 mb-2">
                                                <div class="progress-bar bg-success"
                                                     style="width: 25%">
                                                    收到訂單
                                                </div>

                                                <div class="progress-bar" :class="{'bg-success': order.status >= 1, 'bg-secondary': order.status < 1}"
                                                     style="width: 25%">
                                                    處理中
                                                </div>
                                                <div class="progress-bar" :class="{'bg-success': order.status >= 2, 'bg-secondary': order.status < 2}"
                                                     style="width: 25%">
                                                    已出貨
                                                </div>
                                                <div class="progress-bar" :class="{'bg-success': order.status >= 3, 'bg-secondary': order.status < 3}"
                                                     style="width: 25%">
                                                    已送達
                                                </div>
                                            </div>
                                            <strong>產品明細：</strong>
                                            <div class="accordion-body collapse" :id="'order' + order.id">
                                                <table class="table table-bordered mt-3">
                                                    <thead>
                                                        <tr>
                                                            <th class="text-center">編號</th>
                                                            <th class="text-center">品名</th>
                                                            <th class="text-center">數量</th>
                                                            <th class="text-center">價格</th>
                                                            <th class="text-center">小計</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr v-for="(item,index) in order.orderItems" :key="item.id">
                                                            <td class="text-center">{{ index+1 }}</td>
                                                            <td>{{ item.productName }}<br />規格：{{ item.skuItemName ? item.skuItemName : '基本款' }}</td>
                                                            <td class="text-end">{{formatCurrency(item.qty)}}</td>
                                                            <td class="text-end">$ {{formatCurrency(item.price)}}</td>
                                                            <td class="text-end">$ {{formatCurrency(item.subTotal)}}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                    </div>
                    <!-- 未完成訂單end -->
                        <!-- 已完成訂單start -->
                        <div>
                            <hr class="mt-5" style="background-color: red; height: 2px" />
                            <h3 class="mt-5">已完成訂單</h3>
                            <div class="accordion accordion-menu" id="accordionExample">
                                <table v-for="order in completedOrders" class="table table-striped">
                                    <thead>
                                        <tr class="text-center">
                                            <th>訂單編號</th>
                                            <th>日期</th>
                                            <th>訂單狀態</th>
                                            <th>總價</th>
                                            <th>發票</th>
                                            <th>付款方式</th>
                                            <th>退貨</th>
                                            <th>備註</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr :key="order.id" class="text-center">
                                            <td>
                                                <a class="btn btn-link" data-bs-toggle="collapse" :href="'#order' + order.id" role="button" aria-expanded="false" :aria-controls="'order' + order.id">
                                                    {{ order.no }}
                                                </a>
                                            </td>
                                            <td>{{ formatDate(order.createDate)}}</td>
                                            <td>{{ getOrderStatus(order.status) }}</td>
                                            <td>
                                                $ {{formatCurrency(order.totalAmount)}}
                                            </td>
                                            <td>電子發票</td>
                                            <td>{{ getPaymentMethod(order.paymentMethod) }}</td>
                                            <td>7天內可退貨</td>
                                            <td>無</td>
                                        </tr>
                                        <tr>
                                            <td colspan="8">
                                                <div class="progress mt-2 mb-2">
                                                    <div class="progress-bar bg-success"
                                                         style="width: 25%">
                                                        收到訂單
                                                    </div>

                                                    <div class="progress-bar" :class="{'bg-success': order.status >= 1, 'bg-secondary': order.status < 1}"
                                                         style="width: 25%">
                                                        處理中
                                                    </div>
                                                    <div class="progress-bar" :class="{'bg-success': order.status >= 2, 'bg-secondary': order.status < 2}"
                                                         style="width: 25%">
                                                        已出貨
                                                    </div>
                                                    <div class="progress-bar" :class="{'bg-success': order.status >= 3, 'bg-secondary': order.status < 3}"
                                                         style="width: 25%">
                                                        已送達
                                                    </div>
                                                </div>
                                                <strong>產品明細：</strong>
                                                <div class="accordion-body collapse" :id="'order' + order.id">
                                                    <table class="table table-bordered mt-3">
                                                        <thead>
                                                            <tr>
                                                                <th class="text-center">編號</th>
                                                                <th class="text-center">品名</th>
                                                                <th class="text-center">數量</th>
                                                                <th class="text-center">價格</th>
                                                                <th class="text-center">小計</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr v-for="(item,index) in order.orderItems" :key="item.id">
                                                                <td class="text-center">{{ index+1 }}</td>
                                                                <td>{{ item.productName }}<br />規格：{{ item.skuItemName ? item.skuItemName : '基本款' }}</td>
                                                                <td class="text-end">{{formatCurrency(item.qty)}}</td>
                                                                <td class="text-end">$ {{formatCurrency(item.price)}}</td>
                                                                <td class="text-end">$ {{formatCurrency(item.subTotal)}}</td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 已完成訂單end -->
</section>
            </div>
        </main>
        <footer-component></footer-component>
    </div>

    <script type="module">
        import { HeaderComponent, FooterComponent } from "../Scripts/shared-components.js";
        const app = Vue.createApp({
            data() {
                return {
                    orders: [], 
                };
            },
            mounted() {
                // 確保在組件掛載時從 API 正確地獲取資料
                this.fetchOrders();
            },
            computed: {
                filteredOrders() {
                    return this.orders.filter(order => order.status === 1 || order.status === 2 || order.status === 4);
                },
                completedOrders() {
                    return this.orders.filter(order => order.status === 3 || order.status === 5);
                }
            },
            created() {
                let userId = localStorage.getItem("userId");
                if (!userId) {
                    userId = 3; // 預設值
                    localStorage.setItem("userId", userId);
                    /*console.error("未找到會員ID，請先登入");*/
                }
                console.log("User ID:", userId); // 檢查 userId
                this.fetchOrders(userId);
              },
            methods: {
                async fetchOrders(userId) {
                    try {
                        const response = await fetch(`/api/Members/Orders/${userId}`);
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        const data = await response.json();
                        this.orders = data; // 假設 API 返回的資料結構
                        console.log("orders:", this.orders); // 檢查 orders 的內容
                    } catch (error) {
                        console.error('Error fetching orders:', error);
                    }
                },
                formatCurrency(value) {
                    if (typeof value !== "number" || isNaN(value)) {
                        return "0";
                    }
                    return value.toLocaleString();
                },
                formatDate(dateString) {
                    const date = new Date(dateString);
                    return date.toISOString().split('T')[0]; // 只保留日期部分
                },
                getOrderStatus(status) {
                    const statusMap = {
                        1: '處理中',
                        2: '已出貨',
                        3: '已完成',
                        4: '已申請退貨',
                        5: '已退貨'
                    };
                    return statusMap[status] || '未知狀態';
                },
                getPaymentMethod(method) {
                    const paymentMap = {
                        1: '貨到付款',
                        2: '信用卡'
                    };
                    return paymentMap[method] || '未知付款方式';
                },
            },
            
                  });

        app.component("header-component", HeaderComponent);
        app.component("footer-component", FooterComponent);
        app.mount("#app");
    </script>
</body>
</html>
