<!DOCTYPE html>
<html lang="zh-tw">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fat4Fun-PC</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../Content/NavFooter.css" />
    <!-- <script src="/shared-components.js"></script> -->
    <script src="../Scripts/vue.global.js"></script>

    <style>
      .accordion-menu {
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        background-color: #f8f9fa;
        padding: 1rem;
        margin-top: 150px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
      }
      .accordion-item {
        border: none;
      }
      .accordion-button {
        background-color: #343a40;
        color: white;
      }
      .accordion-button:not(.collapsed) {
        background-color: #495057;
        color: white;
      }
      .accordion-button:focus {
        box-shadow: none;
      }
      .accordion-body ul {
        padding-left: 1rem;
      }
      .accordion-body ul li {
        list-style: none;
      }
      .accordion-body ul li a {
        text-decoration: none;
        color: #495057;
        cursor: pointer;
      }
      .accordion-body ul li a:hover {
        color: #007bff;
      }
      .content {
        margin-top: 150px;
        margin-left: 260px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
      }
      .card-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
      }
      .card {
        display: flex;
        flex-direction: column;
        height: 100%;
        border: none;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      .card-img-top {
        height: 200px;
        object-fit: cover;
      }
      .card-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding: 1rem;
      }
      .card-title {
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }
      .card-text {
        font-size: 0.9rem;
        color: #6c757d;
        flex-grow: 1;
      }
      .card-brand,
      .card-price {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }
      .card-brand {
        color: #007bff;
      }
      .card-price {
        font-weight: bold;
        color: #28a745;
      }
      .btn-add-to-cart {
        width: 100%;
        margin-top: 0.5rem;
      }
      .pagination {
        margin-top: auto;
      }
    </style>
  </head>
  <body>
      <div id="app">
          <header-component @search="handleSearch"></header-component>

          <div class="accordion accordion-menu" id="accordionExample">
              <div class="accordion-item"
                   v-for="(item, index) in series"
                   :key="index">
                  <h2 class="accordion-header" :id="'heading' + index">
                      <button class="accordion-button"
                              type="button"
                              data-bs-toggle="collapse"
                              :data-bs-target="'#collapse' + index"
                              aria-expanded="false"
                              :aria-controls="'collapse' + index"
                              @click="selectedAccordion = index"
                              :class="{'active-accordion': selectedAccordion === index}">
                          {{ item.name }}
                      </button>
                  </h2>
                  <div :id="'collapse' + index"
                       class="accordion-collapse collapse"
                       data-bs-parent="#accordionExample">
                      <div class="accordion-body">
                          <ul>
                              <li v-for="sub in item.subcategories" :key="sub.name">
                                  <a href="#" @click="filterBySubcategory(sub.name)">{{ sub.name }}</a>
                              </li>
                          </ul>
                      </div>
                  </div>
              </div>
          </div>

          <div class="content">
              <div class="row mb-3">
                  <div class="col-md-2">
                      <input id="minPrice"
                             type="number"
                             class="form-control"
                             v-model.number="minPrice"
                             placeholder="最低價格"
                             @input="filterProducts" />
                  </div>
                  <div class="col-md-2">
                      <input id="maxPrice"
                             type="number"
                             class="form-control"
                             v-model.number="maxPrice"
                             placeholder="最高價格"
                             @input="filterProducts" />
                  </div>
                  <div class="col-md-2">
                      <select id="priceSort"
                              class="form-select"
                              v-model="selectedPriceSort"
                              @change="filterProducts">          
                          <option value="name">默認排序</option>
                          <option value="price_asc">價格：低到高</option>
                          <option value="price_desc">價格：高到低</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <select id="brandSelect"
                              class="form-select"
                              v-model="selectedBrand"
                              @change="filterProducts">
                          <option value="">所有品牌</option>
                          <option value="華碩">ASUS-華碩</option>
                          <option value="微星">MSI-微星</option>
                          <option value="宏碁">ACER-宏碁</option>
                          <option value="技嘉">GIGABYTE-技嘉</option>
                      
                      </select>
                  </div>
                  <div class="col-md-2">
                      <select id="categorySelect"
                              class="form-select"
                              v-model="selectedCategory"
                              @change="updateSubOptions">
                          <option value="">選擇類別</option>
                          <option value="harddrive">硬碟</option>
                          <option value="memory">記憶體</option>
                          <option value="gpu">顯示卡</option>
                      </select>
                  </div>
                  <div class="col-md-2">
                      <select id="subCategorySelect"
                              class="form-select"
                              v-model="selectedSubCategory"
                              @change="filterProducts">
                          <option value="">請先選擇類別</option>
                          <option v-for="option in subOptions"
                                  :key="option"
                                  :value="option">
                              {{ option }}
                          </option>
                      </select>
                  </div>
              </div>

              <div class="card-container" style="flex-grow: 1">
                  <div class="card"
                       v-for="product in paginatedProducts"
                       :key="product.id"
                       @click="goToPcDetail(product.id)">
                      <img :src="product.image"
                           class="card-img-top"
                           :alt="product.name" />
                      <div class="card-body">
                          <h5 class="card-title">{{ product.name }}</h5>
                          <p class="card-text">{{ product.description }}</p>
                          <p class="card-brand">品牌: {{ product.brand }}</p>

                          
                          <p class="card-price">價格: ${{ product.specs[0].price }}</p>

                          <!-- 顯示默認規格 -->
                          <p class="card-specs">規格: {{ product.specs[0].name }}</p>

                          <button class="btn btn-primary btn-add-to-cart"
                                  @click.stop="addToCart(product)">
                              加入購物車
                          </button>
                      </div>
                  </div>
              </div>

              <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-center">
                      <li class="page-item" :class="{ disabled: currentPage === 1 }">
                          <a class="page-link"
                             href="#"
                             @click.prevent="setCurrentPage(currentPage - 1)">上一頁</a>
                      </li>
                      <li class="page-item"
                          v-for="page in totalPages"
                          :key="page"
                          :class="{ active: currentPage === page }">
                          <a class="page-link"
                             href="#"
                             @click.prevent="setCurrentPage(page)">{{ page }}</a>
                      </li>
                      <li class="page-item"
                          :class="{ disabled: currentPage === totalPages }">
                          <a class="page-link"
                             href="#"
                             @click.prevent="setCurrentPage(currentPage + 1)">下一頁</a>
                      </li>
                  </ul>
              </nav>
          </div>
          <footer-component></footer-component>
      </div>
      <script type="module">
          import { HeaderComponent, FooterComponent } from "../Scripts/shared-components.js";
          const app = Vue.createApp({
              data() {
                  return {
                      selectedSubcategory: "",
                      selectedBrand: "",
                      selectedPriceSort: "name",
                      minPrice: null,
                      maxPrice: null,
                      selectedCategory: "",
                      selectedSubCategory: "",
                      subOptions: [],
                      series: [], // 分類系列數據
                      products: [], // 全部商品數據
                      filteredProducts: [], // 已過濾商品數據
                      currentPage: 1, // 當前頁碼
                      itemsPerPage: 10, // 每頁顯示商品數量
                  };
              },
              mounted() {
                  // 加載商品數據
                 
                  fetch("/api/products/GetProducts?categoryName=PC")
                      .then((response) => response.json())
                      .then((data) => {
                          this.products = data;
                          this.filteredProducts = data; // 初始化顯示所有商品               
                      })
                      .catch((error) => console.error("Error loading products:", error));

                  // 加載系列數據
                  fetch("series.json")
                      .then((response) => response.json())
                      .then((data) => {
                          this.series = data;
                      })
                      .catch((error) => console.error("Error loading series:", error));
              },
              computed: {
                  // 返回當前顯示的商品
                  paginatedProducts() {
                      const start = (this.currentPage - 1) * this.itemsPerPage;
                      const end = start + this.itemsPerPage;
                      return this.filteredProducts.slice(start, end);
                  },
                 //計算總頁數
                  totalPages() {
                      return Math.ceil(this.filteredProducts.length / this.itemsPerPage);
                  },
              },
              methods: {
                  filterBySubcategory(subcategory) {
                      this.selectedSubcategory = subcategory;
                      this.filterProducts();
                  },

                  updateSubOptions() {
                      if (this.selectedCategory === "harddrive") {
                          this.subOptions = ["1T", "2T", "4T"];
                      } else if (this.selectedCategory === "memory") {
                          this.subOptions = ["8G", "16G", "32G"];
                      } else if (this.selectedCategory === "gpu") {
                          this.subOptions = ["RTX3060", "RTX3070", "RTX3080"];
                      } else {
                          this.subOptions = [];
                      }
                      this.selectedSubCategory = ""; 
                      this.filterProducts(); 
                  },

                  filterProducts() {
                      let products = this.products.filter((product) => {
                          const matchesSubcategory = this.selectedSubcategory
                              ? product.category === this.selectedSubcategory
                              : true;
                          const matchesBrand = this.selectedBrand
                              ? product.brand === this.selectedBrand
                              : true;

                          const matchesSpecs = product.specs.some((spec) => {
                              const matchesMinPrice =
                                  this.minPrice !== null ? spec.price >= this.minPrice : true;
                              const matchesMaxPrice =
                                  this.maxPrice !== null ? spec.price <= this.maxPrice : true;

                              let matchesSubCategory = true;
                              if (this.selectedCategory && this.selectedSubCategory) {
                                  const categoryKey = this.selectedCategory;
                                  matchesSubCategory =
                                      spec[categoryKey] === this.selectedSubCategory;
                              }


                              // 檢查是否需要 Intel 或 AMD 特定的過濾
                              const isIntel = this.series.some(series => series.name === "Intel");
                              const isAMD = this.series.some(series => series.name === "AMD");

                              if (isIntel && this.selectedSubcategory === "Intel") {
                                  return matchesMinPrice && matchesMaxPrice && matchesSubCategory && spec.specifications.includes("I");
                              } else if (isAMD && this.selectedSubcategory === "AMD") {
                                  return matchesMinPrice && matchesMaxPrice && matchesSubCategory && spec.specifications.includes("R");
                              } else {
                                  return matchesMinPrice && matchesMaxPrice && matchesSubCategory;
                              }
                          });

                          return matchesSubcategory && matchesBrand && matchesSpecs;
                      });
                     

                      // 根据价格排序
                      //if (this.selectedPriceSort === "price_asc") {
                      //    products.sort((a, b) => a.specs[0].price - b.specs[0].price);
                      //} else if (this.selectedPriceSort === "price_desc") {
                      //    products.sort((a, b) => b.specs[0].price - a.specs[0].price);
                      //}
                      // 處理排序
                      //if (this.selectedPriceSort === "price_asc") {
                      //    products.sort((a, b) => a.specs[0].price - b.specs[0].price);
                      //} else if (this.selectedPriceSort === "price_desc") {
                      //    products.sort((a, b) => b.specs[0].price - a.specs[0].price);
                      //} else {
                      //    // 默認排序：根據產品名稱排序
                      //    products.sort((a, b) => a.name.localeCompare(b.name));
                      //}
                      

                      const categoryName = "PC";
                      const brand = this.selectedBrand;
                      const maxPrice = this.maxPrice;
                      const minPrice = this.minPrice;
                      const category = this.selectedCategory;
                      const subCategory = this.selectedSubCategory;
                      const sortPrice = this.selectedPriceSort;

                      // 創建一個包含所有參數的對象
                      const params = {
                          brand: brand,
                          categoryName: categoryName,
                          maxPrice: maxPrice,
                          minPrice: minPrice,
                          key: category,
                          value: subCategory,
                          sort:sortPrice
                      };

                      // 將有效的參數轉換成查詢字串
                      const queryString = Object.keys(params)
                          .filter(key => params[key] !== undefined && params[key] !== null && params[key] !== '') // 過濾掉未定義、null 和空字串的參數
                          .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`) // 將有效參數轉換成查詢參數
                          .join('&');

                      // 發送帶有動態查詢參數的請求
                      fetch(`/api/products/GetProducts?${queryString}`)
                          .then((response) => response.json())
                          .then((data) => {
                              this.products = data;
                              this.filteredProducts = data;               
                          })
                          .catch((error) => console.error("Error loading products:", error));
                  },



                  setCurrentPage(page) {
                      if (page >= 1 && page <= this.totalPages) {
                          this.currentPage = page;
                      }
                  },

                  goToPcDetail(productId) {
                      window.location.href = `PcDetail.html?id=${productId}`;
                  },

                  
                  handleSearch(query) {
                      if (query) {
                          this.filteredProducts = this.products.filter((product) => {
                              // 檢查產品名稱是否包含搜尋關鍵字
                              const matchesName = product.name.toLowerCase().includes(query.toLowerCase());

                              // 檢查產品的任意規格是否包含搜尋關鍵字
                              const matchesSpecs = product.specs.some((spec) =>
                                  spec.name.toLowerCase().includes(query.toLowerCase())
                              );

                              // 只要名稱或規格匹配就返回 true
                              return matchesName || matchesSpecs;
                          });
                      } else {
                          this.filteredProducts = this.products;
                      }
                  },
              },
          });

          app.component("header-component", HeaderComponent);
          app.component("footer-component", FooterComponent);

          app.mount("#app");
      </script>
  </body>

  
</html>
