<!DOCTYPE html>
<html lang="zh-TW" style="background-color: #f0f2f5">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fat4Fun-確認訂單資料</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="../Content/NavFooter.css" />
    <script src="../Scripts/vue.global.js"></script>
    <style>
      .stepper {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
      }

      .step {
        text-align: center;
        width: 100%;
        position: relative;
      }

      .step:not(:last-child)::after {
        content: "";
        position: absolute;
        top: 50%;
        right: -50%;
        width: 100%;
        height: 2px;
        background-color: #e0e0e0;
        z-index: 1;
      }

      .step.active .circle {
        background-color: #c6a272;
        color: white;
      }

      .circle {
        display: inline-block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        border-radius: 50%;
        background-color: #e0e0e0;
        z-index: 2;
      }

      .label {
        margin-top: 10px;
        font-size: 14px;
        color: #7d7d7d;
      }

      .step.active .label {
        color: #000;
      }

      .table th,
      .table td {
        width: 25%; /* 根據需要調整 */
      }

      .table .text-end {
        text-align: right;
      }

      h4 {
        color: #222;
      }

      .btn-primary {
        background-color: #007bff; /* 按鈕主色 */
        border-color: #007bff; /* 按鈕邊框顏色 */
      }

      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #004085;
      }
    </style>
  </head>

  <body style="background-color: #f0f2f5">
    <div id="app">
      <!-- nav start-->
      <header-component></header-component>
      <!-- nav end -->

      <!-- 購物流程Start -->
      <div class="container" style="margin-top: 180px">
        <div class="stepper">
          <!-- 第一步 -->
          <div class="step">
            <div class="circle">1</div>
            <div class="label">購物車及填寫資料</div>
          </div>

          <!-- 第二步 -->
          <div class="step active">
            <div class="circle">2</div>
            <div class="label">確認資料</div>
          </div>

          <!-- 第三步 -->
          <div class="step">
            <div class="circle">3</div>
            <div class="label">訂購完成</div>
          </div>
        </div>
      </div>
      <!-- 購物流程End -->

      <!-- 商品列表 -->
      <div id="app" class="container mt-5" style="color: #333">
        <div>
          <h4>確認商品內容</h4>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th class="text-center">商品</th>
                <th class="text-center">數量</th>
                <th class="text-center">單價</th>
                <th class="text-center">總價</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="item in cartItems" :key="item.id">
                <td>
                  {{ item.product.name }}
                  <!-- 如果有 SKU 規格名稱顯示 -->
                  <div style="white-space: nowrap; font-size: 0.9em">
                    規格：
                    <span v-if="item.skuItem && item.skuItem.value">
                      {{ item.skuItem.value }}
                    </span>
                    <span v-else> 基本款 </span>
                    <!-- 如果有加價則顯示 -->
                    <span v-if="item.skuItem && item.skuItem.skuPrice > 0">
                      +{{ formatCurrency(item.skuItem.skuPrice) }} 元
                    </span>
                  </div>
                </td>
                <td class="text-center pt-3">{{ item.qty }}</td>
                <td class="text-end pt-3">
                  {{ formatCurrency(item.product.price + (item.skuItem ?
                  item.skuItem.skuPrice : 0)) }} 元
                </td>
                <td class="text-end pt-3">
                  {{ formatCurrency(item.qty * (item.product.price +
                  (item.skuItem ? item.skuItem.skuPrice : 0))) }} 元
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="text-end pt-3">總計：</td>
                <td class="text-end">{{ formatCurrency(total) }} 元</td>
              </tr>
            </tfoot>
          </table>
        </div>

        <!-- 顧客資料 -->
        <div>
          <h4 class="mt-4 mb-3">收件人資料</h4>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th class="text-center"><strong>姓名</strong></th>
                <th class="text-center"><strong>電話</strong></th>
                <th class="text-center"><strong>送貨地址</strong></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-center">{{ customer.name }}</td>
                <td class="text-center">{{ customer.phone }}</td>
                <td class="text-center">{{ customer.address }}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 取貨方式 -->
        <div>
          <h4 class="mt-4 mb-3">其他資訊</h4>
          <table class="table table-bordered mt-3">
            <thead>
              <tr>
                <th class="text-center">取貨方式</th>
                <th class="text-center">付款方式</th>
                <th class="text-center">發票選項</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="text-center">宅配</td>
                <td class="text-center">貨到付款</td>
                <td class="text-center">電子發票</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 按鈕 -->
        <div
          class="mt-4 mb-5"
          style="text-align: right; display: flex; gap: 20px"
        >
          <button class="btn btn-secondary w-50" @click="goBack">上一步</button>
          <button class="btn btn-primary w-50" @click="confirmOrder">
            確認送出
          </button>
        </div>
      </div>

      <!-- footer start-->
      <footer-component></footer-component>
      <!-- footer end -->
    </div>
    <script type="module">
      import {
        HeaderComponent,
        FooterComponent,
      } from "../Scripts/shared-components.js";
      const app = Vue.createApp({
        data() {
          const userId = JSON.parse(localStorage.getItem("user"))?.id;

          return {
            cartItems: JSON.parse(localStorage.getItem("cart")) || [],
            customer: JSON.parse(localStorage.getItem("customerInfo")) || {},
            userId: userId,
          };
        },
        computed: {
          total() {
            return this.cartItems.reduce((acc, item) => {
              const price =
                item.product.price +
                (item.skuItem && item.skuItem.skuPrice
                  ? item.skuItem.skuPrice
                  : 0);
              return acc + item.qty * price;
            }, 0);
          },
        },
        methods: {
          formatCurrency(value) {
            if (typeof value !== "number" || isNaN(value)) {
              return "0";
            }
            return value.toLocaleString();
          },
          goBack() {
            window.history.back();
          },
          async confirmOrder() {
            const orderData = {
              UserId: this.userId,
              Vm: {
                RecipientName: this.customer.name,
                ShippingAddress: this.customer.address,
                Phone: this.customer.phone,
                DeliveryMethod: 1,
                PaymentMethod: 1,
                InvoiceOption: 1,
              },
            };
            try {
              const response = await fetch("/api/carts/SubmitOrder", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(orderData),
              });

              if (response.ok) {
                const result = await response.json();
                // 清除本地資料並導向成功頁面
                localStorage.removeItem("cart");
                localStorage.removeItem("customerInfo");
                window.location.href = "Checkout-Success.html";
              } else {
                // 失敗處理，顯示錯誤訊息
                const errorData = await response.json();
                alert("訂單建立失敗: " + errorData.message || "未知的錯誤");
              }
            } catch (error) {
              // 發生異常，顯示錯誤訊息
              alert("發生錯誤: " + error.message);
              console.error("錯誤:", error);
            }
          },
          handleSearch() {
            // 在這裡定義搜尋的邏輯
          },
        },
      });
      app.component("header-component", HeaderComponent);
      app.component("footer-component", FooterComponent);

      app.mount("#app");
    </script>
  </body>
</html>
