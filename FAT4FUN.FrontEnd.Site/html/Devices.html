<!DOCTYPE html>
<html lang="zh-tw">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fat4Fun-Devices</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../Content/NavFooter.css" />
    <script src="../Scripts/vue.global.js"></script>

    <style>
      .accordion-menu {
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        width: 250px;
        background-color: #f8f9fa;
        padding: 1rem;
        margin-top: 150px;
        border-right: 1px solid #ddd;
        overflow-y: auto;
      }

      .accordion-item {
        border: none;
      }

      .accordion-button {
        background-color: #343a40;
        color: white;
      }

      .accordion-button:not(.collapsed) {
        background-color: #495057;
        color: white;
      }

      .accordion-button:focus {
        box-shadow: none;
      }

      .accordion-body ul {
        padding-left: 1rem;
      }

      .accordion-body ul li {
        list-style: none;
      }

      .accordion-body ul li a {
        text-decoration: none;
        color: #495057;
        cursor: pointer;
      }

      .accordion-body ul li a:hover {
        color: #007bff;
      }

      .content {
        margin-top: 150px;
        margin-left: 260px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        min-height: 80vh;
      }

      .card-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
      }

      .card {
        display: flex;
        flex-direction: column;
        height: 100%;
        border: none;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer; /* 在鼠标悬停时显示手指 */
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

        .card-img-top {
            height: 200px;
            object-fit: cover;
            padding: 1rem;
        }

      .card-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding: 1rem;
      }

      .card-title {
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .card-text {
        font-size: 0.9rem;
        color: #6c757d;
        flex-grow: 1;
      }

      .card-brand,
      .card-price {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .card-brand {
        color: #007bff;
      }

      .card-price {
        font-weight: bold;
        color: #28a745;
      }
      /* 愛心按鈕樣式 */
      .btn-wishlist {
        padding: 0.25rem 0.5rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #dc3545; /* 愛心按鈕紅色 */
        border-color: #dc3545;
      }

      /* 加入購物車按鈕樣式 */
      .btn-add-to-cart {
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
      }
      /*.btn-add-to-cart {
  width: 100%;
  margin-top: 0.5rem;
}*/
      .pagination {
        margin-top: auto;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <header-component @search="handleSearch"></header-component>

      <div class="accordion accordion-menu" id="accordionExample">
        <div
          class="accordion-item"
          v-for="(item, index) in series"
          :key="index"
        >
          <h2 class="accordion-header" :id="'heading' + index">
            <button
              class="accordion-button"
              type="button"
              data-bs-toggle="collapse"
              :data-bs-target="'#collapse' + index"
              aria-expanded="false"
              :aria-controls="'collapse' + index"
              @click="setAccordion(item?.name)"
              :class="{'active-accordion': selectedAccordion === item?.name}"
            >
              {{ item?.name }}
            </button>
          </h2>
          <div
            :id="'collapse' + index"
            class="accordion-collapse collapse"
            data-bs-parent="#accordionExample"
          >
            <div class="accordion-body">
              <ul>
                <li v-for="sub in item.subcategories" :key="sub?.name">
                  <a href="#" @click="setAccordion(sub?.name)"
                    >{{ sub?.name }}</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="row mb-3">
          <div class="col-md-2">
            <input
              id="minPrice"
              type="number"
              class="form-control"
              v-model.number="minPrice"
              placeholder="最低價格"
              @input="filterProducts"
            />
          </div>
          <div class="col-md-2">
            <input
              id="maxPrice"
              type="number"
              class="form-control"
              v-model.number="maxPrice"
              placeholder="最高價格"
              @input="filterProducts"
            />
          </div>
          <div class="col-md-2">
            <select
              id="priceSort"
              class="form-select"
              v-model="selectedPriceSort"
              @change="filterProducts"
            >
              <option value="name">默認排序</option>
              <option value="price_asc">價格：低到高</option>
              <option value="price_desc">價格：高到低</option>
            </select>
          </div>
          <div class="col-md-2">
            <select
              id="brandSelect"
              class="form-select"
              v-model="selectedBrand"
              @change="filterProducts"
            >
              <option value="">所有品牌</option>
              <option value="羅技">Logitech-羅技</option>
              <option value="海盜船">Corsair-海盜船</option>
              <option value="雷蛇">Razer-雷蛇</option>
              <option value="INTEL">INTEL-酷睿</option>
              <option value="AMD">AMD-銳龍</option>
              <option value="金士頓">Kingston-金士頓</option>
              <option value="美光">Micron-美光</option>
            </select>
          </div>
          <!--<div class="col-md-2">
                        <select id="categorySelect"
                                class="form-select"
                                v-model="selectedCategory"
                                @change="updateSubOptions">
                            <option value="">選擇類別</option>
                            <option value="harddrive">硬碟</option>
                            <option value="memory">記憶體</option>
                            <option value="gpu">顯示卡</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select id="subCategorySelect"
                                class="form-select"
                                v-model="selectedSubCategory"
                                @change="filterProducts">
                            <option value="">請先選擇類別</option>
                            <option v-for="option in subOptions"
                                    :key="option"
                                    :value="option">
                                {{ option }}
                            </option>
                        </select>
                    </div>
                </div>-->
        </div>
        <div class="card-container" style="flex-grow: 1">
          <div
            class="card"
            v-for="product in paginatedProducts"
            :key="product.id"
            @click="goToPcDetail(product.id)"
          >
            <img
              :src="product.image"
              class="card-img-top"
              :alt="product?.name"
            />
            <div class="card-body">
              <h5 class="card-title">{{ product?.name }}</h5>
              <p class="card-text">{{ product.description }}</p>
              <p class="card-brand">品牌: {{ product.brand }}</p>
              <p class="card-price">價格: ${{ product.specs[0]?.price.toLocaleString() }}</p>
              <!-- 顯示默認規格 -->
              <p class="card-specs">規格: {{ product.specs[0]?.name }}</p>
              <div class="d-flex justify-content-between">
                <!-- 愛心按鈕 -->
                <button
                  class="btn btn-outline-danger btn-wishlist me-3"
                  @click.stop="addToWishlist(product)"
                >
                  <i class="fas fa-heart"></i>
                </button>
                <!-- 加入購物車按鈕 -->
                <button
                  class="btn btn-primary btn-add-to-cart"
                  @click.stop="addToCart(product)"
                >
                  加入購物車
                </button>
              </div>
            </div>
          </div>
        </div>

        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
              <a
                class="page-link"
                href="#"
                @click.prevent="setCurrentPage(currentPage - 1)"
                >上一頁</a
              >
            </li>
            <li
              class="page-item"
              v-for="page in totalPages"
              :key="page"
              :class="{ active: currentPage === page }"
            >
              <a
                class="page-link"
                href="#"
                @click.prevent="setCurrentPage(page)"
                >{{ page }}</a
              >
            </li>
            <li
              class="page-item"
              :class="{ disabled: currentPage === totalPages }"
            >
              <a
                class="page-link"
                href="#"
                @click.prevent="setCurrentPage(currentPage + 1)"
                >下一頁</a
              >
            </li>
          </ul>
        </nav>
      </div>
      <footer-component></footer-component>
    </div>
    <script type="module">
      import {
        HeaderComponent,
        FooterComponent,
      } from "../Scripts/shared-components.js";
      const app = Vue.createApp({
        data() {
          return {
            selectedSubcategory: "",
            selectedBrand: "",
            selectedPriceSort: "name",
            minPrice: null,
            maxPrice: null,
            selectedCategory: "",
            selectedSubCategory: "",
            selectedAccordion: "",
            subOptions: [],
            series: [], // 分類系列數據
            products: [], // 全部商品數據
            filteredProducts: [], // 已過濾商品數據
            currentPage: 1, // 當前頁碼
            itemsPerPage: 10, // 每頁顯示商品數量
          };
        },
        mounted() {
          // 解析 URL 查询参数
          const params = new URLSearchParams(window.location.search);
          const categoryName = params.get("categoryname") || ""; // 获取类别名称，默认为空字符串

          // 如果 categoryName 存在，发起带有类别过滤的 API 请求
          let apiUrl = "/api/products/GetListProducts";
          if (categoryName) {
            apiUrl += `?CategoryName=${encodeURIComponent(categoryName)}`;
          }
          // 加載商品數據
          fetch(apiUrl)
            .then((response) => response.json())
            .then((data) => {
              this.products = data;
              this.filteredProducts = data; // 初始化顯示所有商品
            })
            .catch((error) => console.error("Error loading products:", error));

          // 加載系列數據
          fetch("series2.json")
            .then((response) => response.json())
            .then((data) => {
              this.series = data;
            })
            .catch((error) => console.error("Error loading series:", error));
        },
        computed: {
          // 返回當前顯示的商品
          paginatedProducts() {
            const start = (this.currentPage - 1) * this.itemsPerPage;
            const end = start + this.itemsPerPage;
            const searchName = new URLSearchParams(window.location.search).get(
              "search"
            );
            if (searchName) {
              this.handleSearch(searchName);
            }
            return this.filteredProducts.slice(start, end);
          },
          //計算總頁數
          totalPages() {
            return Math.ceil(this.filteredProducts.length / this.itemsPerPage);
          },
        },

        methods: {
          setAccordion(seriesName) {
            this.removeSearchParams();
            this.selectedAccordion = seriesName;
            this.filterProducts();
          },

          removeSearchParams() {
            const url = new URL(window.location.href);
            url.search = "";
            window.history.replaceState({}, document.title, url.toString());
          },

          filterBySubcategory(subcategory) {
            this.selectedSubcategory = subcategory;
            this.filterProducts();
          },

          filterProducts() {
            let products = this.products.filter((product) => {
              const matchesSubcategory = this.selectedSubcategory
                ? product.category === this.selectedSubcategory
                : true;
              const matchesBrand = this.selectedBrand
                ? product.brand === this.selectedBrand
                : true;

              const matchesSpecs = product.specs.some((spec) => {
                const matchesMinPrice =
                  this.minPrice !== null ? spec?.price >= this.minPrice : true;
                const matchesMaxPrice =
                  this.maxPrice !== null ? spec?.price <= this.maxPrice : true;

                let matchesSubCategory = true;
                if (this.selectedCategory && this.selectedSubCategory) {
                  const categoryKey = this.selectedCategory;
                  matchesSubCategory =
                    spec[categoryKey] === this.selectedSubCategory;
                }
              });

              return matchesSubcategory && matchesBrand && matchesSpecs;
            });

            const categoryName = null;
            const brand = this.selectedBrand;
            const maxPrice = this.maxPrice;
            const minPrice = this.minPrice;
            const category = this.selectedCategory;
            const subCategory = this.selectedSubCategory;
            const sortPrice = this.selectedPriceSort;
            const accordion = this.selectedAccordion;

            // 創建一個包含所有參數的對象
            const params = {
              brand: brand,
              categoryName: categoryName,
              maxPrice: maxPrice,
              minPrice: minPrice,
              key: category,
              value: subCategory,
              sort: sortPrice,
              accordion: this.selectedAccordion,
            };

            // 將有效的參數轉換成查詢字串
            const queryString = Object.keys(params)
              .filter(
                (key) =>
                  params[key] !== undefined &&
                  params[key] !== null &&
                  params[key] !== ""
              ) // 過濾掉未定義、null 和空字串的參數
              .map(
                (key) =>
                  `${encodeURIComponent(key)}=${encodeURIComponent(
                    params[key]
                  )}`
              ) // 將有效參數轉換成查詢參數
              .join("&");
            //console.log(accordion)
            // 發送帶有動態查詢參數的請求
            fetch(`/api/products/GetListProducts?${queryString}`)
              .then((response) => response.json())
              .then((data) => {
                this.products = data;
                this.filteredProducts = data;
              })
              .catch((error) =>
                console.error("Error loading products:", error)
              );
          },

          setCurrentPage(page) {
            if (page >= 1 && page <= this.totalPages) {
              this.currentPage = page;
            }
          },

          goToDeviceDetail(productId) {
            window.location.href = `DeviceDetail.html?id=${productId}`;
          },

          handleSearch(query) {
            console.log("查询内容:", query, "类型:", typeof query); // 调试信息

            // 搜索逻辑
            if (query) {
              // 将查询字符串转换为小写，避免大小写问题
              const lowerCaseQuery = query.toLowerCase();

              // 过滤产品：根据产品名称或规格名称进行搜索
              this.filteredProducts = this.products.filter((product) => {
                const matchesName = product?.name
                  .toLowerCase()
                  .includes(lowerCaseQuery);
                const matchesSpecs = product.specs.some((spec) =>
                  spec?.name.toLowerCase().includes(lowerCaseQuery)
                );
                // 如果名称或规格匹配，返回该产品
                return matchesName || matchesSpecs;
              });
            } else {
              // 如果没有输入查询，则重置为显示所有产品
              this.filteredProducts = this.products;
            }

            // 重新计算分页总页数
            this.currentPage = 1;
          },

          checkToCart(SkuId, SkuItemId) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }

            return fetch(
              `/api/products/QueryCart?UserId=${userId}&ProductSkuId=${SkuId}&SkuItemId=${SkuItemId}`,
              {
                headers: {
                  "Content-Type": "application/json",
                },
              }
            )
              .then((response) => response.json())
              .then((exists) => {
                return exists; // 返回 true 或 false
              })
              .catch((error) => {
                console.error("Error checking cart:", error);
                return false; // 出現錯誤時返回 false
              });
          },

          // 用來新增商品或更新商品數量到購物車
          addToCart(product) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }

            const SkuId = product.specs[0].id; // 取得 SkuId
            const SkuItemId = null; // 取得 SkuItemId
            // 檢查商品是否存在於購物車
            this.checkToCart(SkuId, SkuItemId).then((exists) => {
              const item = {
                UserId: userId, // 假設用戶ID為3
                ProductSkuId: SkuId,
                ProductSkuItemId: SkuItemId,
                Qty: 1, // 默認數量為1
              };

              if (exists) {
                //如果商品存在購物車中，更新數量
                // 呼叫saveToCart，將商品發送到後端
                fetch("/api/products/SaveToCart", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(item),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    Swal.fire({
                      //position: "top-end",
                      icon: "info",
                      title: "商品數量已增加",
                      showConfirmButton: false,
                      timer: 1500,
                    });
                    //alert("商品數量已增加");
                  })
                  .catch((error) =>
                    console.error("Error updating item in cart:", error)
                  );
              } else {
                // 如果商品不存在購物車中 就新增商品到購物車
                fetch("/api/products/SaveToCart", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(item),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    Swal.fire({
                      //position: "top-end",
                      icon: "success",
                      title: "商品已加入購物車",
                      showConfirmButton: false,
                      timer: 1500,
                    });
                    //alert("商品已加入購物車");
                  })
                  .catch((error) =>
                    console.error("Error adding item to cart:", error)
                  );
              }
            });
          },
          // 檢查是否再追蹤清單
          checkToFollow(ProductId) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }

            return fetch(
              `/api/products/QueryFollow?UserId=${userId}&ProductId=${ProductId}`
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error("檢查追蹤清單時出錯");
                }
                return response.json();
              })
              .then((exists) => {
                return exists; // 返回 true 或 false
              })
              .catch((error) => {
                console.error("檢查追蹤清單時出錯:", error);
                return false;
              });
          },

          // 新增商品到追蹤清單
          addToWishlist(product) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }
            const ProductId = product.id;

            // 檢查是否在追蹤清單中
            this.checkToFollow(ProductId).then((exists) => {
              if (exists) {
                Swal.fire({
                  //position: "top-end",
                  icon: "info",
                  title: "商品已在追蹤清單中",
                  showConfirmButton: false,
                  timer: 1500,
                });
                //alert("商品已在追蹤清單中");
              } else {
                // 如果商品不再追蹤清單中 就新增商品到追蹤清單
                const item = {
                  UserId: userId,
                  ProductId: ProductId,
                  Name: product?.name,
                };
                fetch("/api/products/SaveFollow", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(item),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    Swal.fire({
                      //position: "top-end",
                      icon: "success",
                      title: "商品已在追蹤清單中",
                      showConfirmButton: false,
                      timer: 1500,
                    });
                  })
                  .catch((error) =>
                    console.error("加入追蹤清單時出錯:", error)
                  );
              }
            });
          },
          goToPcDetail(productId) {
            // 發送請求更新產品 Look
            fetch(`/api/products/UpdateLook/${productId}`, {
              method: "POST",
            })
              .then((response) => {
                if (!response.ok) {
                  console.error("Failed to update product look");
                } else {
                  // 成功更新後跳轉到產品詳情頁
                  window.location.href = `DevicesDetail.html?id=${productId}`;
                }
              })
              .catch((error) => {
                console.error("Error updating product look:", error);
              });
          },
        },
      });

      app.component("header-component", HeaderComponent);
      app.component("footer-component", FooterComponent);

      app.mount("#app");
    </script>
  </body>
</html>
