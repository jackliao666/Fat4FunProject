<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fat4Fun-Hots</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="../Content/NavFooter.css" />
    <script src="../Scripts/vue.global.js"></script>
    <style>
      .card-container {
        display: grid;
        grid-template-columns: repeat(5, 1fr); /* 固定为5列 */
        gap: 1.5rem;
        padding: 1.5rem;
      }

      .card {
        display: flex;
        flex-direction: column;
        height: 100%;
        border: none;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        cursor: pointer;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .card-img-top {
        height: 200px;
        object-fit: cover;
        padding: 1rem;
      }

      .card-body {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        padding: 1rem;
      }

      .card-title {
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      .card-text {
        font-size: 0.9rem;
        color: #6c757d;
        flex-grow: 1;
      }

      .card-brand,
      .card-price {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .card-brand {
        color: #007bff;
      }

      .card-price {
        font-weight: bold;
        color: #28a745;
      }

      .btn-wishlist {
        padding: 0.25rem 0.5rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #dc3545;
        border-color: #dc3545;
      }

      .btn-add-to-cart {
        padding: 0.25rem 0.5rem;
        font-size: 0.85rem;
      }
    </style>
  </head>

  <body>
    <div id="app">
      <!-- nav start-->
      <header-component @search="handleSearch"></header-component>
      <!-- nav end -->
      <div class="card-container" style="margin-top: 150px">
        <div
          class="card"
          v-for="product in paginatedProducts"
          :key="product.id"
          @click="goToPcDetail(product.id)"
        >
          <img :src="product.image" class="card-img-top" :alt="product?.name" />
          <div class="card-body">
            <h5 class="card-title">{{ product?.name }}</h5>
            <p class="card-text">{{ product.description }}</p>
            <p class="card-brand">品牌: {{ product.brand }}</p>
            <p class="card-price">價格: ${{ product.specs[0]?.price.toLocaleString() }}</p>
            <p class="card-specs">規格: {{ product.specs[0]?.name }}</p>
            <div class="d-flex justify-content-between">
              <!-- 愛心按鈕 -->
              <button
                class="btn btn-outline-danger btn-wishlist me-3"
                @click.stop="addToWishlist(product)"
              >
                <i class="fas fa-heart"></i>
              </button>

              <!-- 加入購物車按鈕 -->

              <button
                class="btn btn-primary btn-add-to-cart"
                @click.stop="addToCart(product)"
              >
                加入購物車
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- footer start-->
      <footer-component></footer-component>
      <!-- footer end -->
    </div>

    <script type="module">
      import {
        HeaderComponent,
        FooterComponent,
      } from "../Scripts/shared-components.js";

      const app = Vue.createApp({
        data() {
          return {
            products: [],
            filteredProducts: [],
            currentPage: 1,
            pageSize: 10,
          };
        },
        mounted() {
          this.fetchTopProducts();
        },
        computed: {
          paginatedProducts() {
            const start = (this.currentPage - 1) * this.pageSize;
            const end = start + this.pageSize;
            return this.filteredProducts.slice(start, end);
          },
          totalPages() {
            return Math.ceil(this.filteredProducts.length / this.pageSize);
          },
        },
        methods: {
          fetchTopProducts() {
            fetch("/api/products/GetTopProducts")
              .then((response) => response.json())
              .then((data) => {
                this.products = data;
                this.filteredProducts = data;
              })
              .catch((error) =>
                console.error("Error loading top products:", error)
              );
          },
          goToPcDetail(productId) {
            window.location.href = `PcDetail.html?id=${productId}`;
          },
          checkToCart(SkuId, SkuItemId) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }

            return fetch(
              `/api/products/QueryCart?UserId=${userId}&ProductSkuId=${SkuId}&SkuItemId=${SkuItemId}`,
              {
                headers: {
                  "Content-Type": "application/json",
                },
              }
            )
              .then((response) => response.json())
              .then((exists) => {
                return exists; // 返回 true 或 false
              })
              .catch((error) => {
                console.error("Error checking cart:", error);
                return false; // 出現錯誤時返回 false
              });
          },

          // 用來新增商品或更新商品數量到購物車
          addToCart(product) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }

            const SkuId = product.specs[0].id; // 取得 SkuId
            const SkuItemId = null; // 取得 SkuItemId
            // 檢查商品是否存在於購物車
            this.checkToCart(SkuId, SkuItemId).then((exists) => {
              const item = {
                UserId: userId, // 假設用戶ID為3
                ProductSkuId: SkuId,
                ProductSkuItemId: SkuItemId,
                Qty: 1, // 默認數量為1
              };

              if (exists) {
                //如果商品存在購物車中，更新數量
                // 呼叫saveToCart，將商品發送到後端
                fetch("/api/products/SaveToCart", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(item),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    Swal.fire({
                      //position: "top-end",
                      icon: "info",
                      title: "商品數量已增加",
                      showConfirmButton: false,
                      timer: 1500,
                    });
                    //alert("商品數量已增加");
                  })
                  .catch((error) =>
                    console.error("Error updating item in cart:", error)
                  );
              } else {
                // 如果商品不存在購物車中 就新增商品到購物車
                fetch("/api/products/SaveToCart", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(item),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    Swal.fire({
                      //position: "top-end",
                      icon: "success",
                      title: "商品已加入購物車",
                      showConfirmButton: false,
                      timer: 1500,
                    });
                    //alert("商品已加入購物車");
                  })
                  .catch((error) =>
                    console.error("Error adding item to cart:", error)
                  );
              }
            });
          },
          // 檢查是否再追蹤清單
          checkToFollow(ProductId) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }

            return fetch(
              `/api/products/QueryFollow?UserId=${userId}&ProductId=${ProductId}`
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error("檢查追蹤清單時出錯");
                }
                return response.json();
              })
              .then((exists) => {
                return exists; // 返回 true 或 false
              })
              .catch((error) => {
                console.error("檢查追蹤清單時出錯:", error);
                return false;
              });
          },

          // 新增商品到追蹤清單
          addToWishlist(product) {
            const userId = JSON.parse(localStorage.getItem("user"))?.id;

            if (!userId) {
              Swal.fire({
                icon: "info",
                title: "請先登入",
                showConfirmButton: false,
                timer: 1500,
              });
              setTimeout(() => {
                window.location.href = "Login.html";
              }, 2000);
              return;
            }
            const ProductId = product.id;

            // 檢查是否在追蹤清單中
            this.checkToFollow(ProductId).then((exists) => {
              if (exists) {
                Swal.fire({
                  //position: "top-end",
                  icon: "info",
                  title: "商品已在追蹤清單中",
                  showConfirmButton: false,
                  timer: 1500,
                });
                //alert("商品已在追蹤清單中");
              } else {
                // 如果商品不再追蹤清單中 就新增商品到追蹤清單
                const item = {
                  UserId: userId,
                  ProductId: ProductId,
                  Name: product?.name,
                };
                fetch("/api/products/SaveFollow", {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(item),
                })
                  .then((response) => response.json())
                  .then((data) => {
                    Swal.fire({
                      //position: "top-end",
                      icon: "success",
                      title: "商品已在追蹤清單中",
                      showConfirmButton: false,
                      timer: 1500,
                    });
                  })
                  .catch((error) =>
                    console.error("加入追蹤清單時出錯:", error)
                  );
              }
            });
          },
        },
        filterProducts() {
          let products = this.products.filter((product) => {
            const matchesSubcategory = this.selectedSubcategory
              ? product.category === this.selectedSubcategory
              : true;
            const matchesBrand = this.selectedBrand
              ? product.brand === this.selectedBrand
              : true;

            const matchesSpecs = product.specs.some((spec) => {
              const matchesMinPrice =
                this.minPrice !== null ? spec?.price >= this.minPrice : true;
              const matchesMaxPrice =
                this.maxPrice !== null ? spec?.price <= this.maxPrice : true;

              let matchesSubCategory = true;
              if (this.selectedCategory && this.selectedSubCategory) {
                const categoryKey = this.selectedCategory;
                matchesSubCategory =
                  spec[categoryKey] === this.selectedSubCategory;
              }
            });

            return matchesSubcategory && matchesBrand && matchesSpecs;
          });

          const categoryName = null;
          const brand = this.selectedBrand;
          const maxPrice = this.maxPrice;
          const minPrice = this.minPrice;
          const category = this.selectedCategory;
          const subCategory = this.selectedSubCategory;
          const sortPrice = this.selectedPriceSort;
          const accordion = this.selectedAccordion;

          // 創建一個包含所有參數的對象
          const params = {
            brand: brand,
            categoryName: categoryName,
            maxPrice: maxPrice,
            minPrice: minPrice,
            key: category,
            value: subCategory,
            sort: sortPrice,
            accordion: this.selectedAccordion,
          };

          // 將有效的參數轉換成查詢字串
          const queryString = Object.keys(params)
            .filter(
              (key) =>
                params[key] !== undefined &&
                params[key] !== null &&
                params[key] !== ""
            ) // 過濾掉未定義、null 和空字串的參數
            .map(
              (key) =>
                `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`
            ) // 將有效參數轉換成查詢參數
            .join("&");
          //console.log(accordion)
          // 發送帶有動態查詢參數的請求
          fetch(`/api/products/GetListProducts?${queryString}`)
            .then((response) => response.json())
            .then((data) => {
              this.products = data;
              this.filteredProducts = data;
            })
            .catch((error) => console.error("Error loading products:", error));
        },
        handleSearch(query) {
          console.log("搜尋字串：", query);
          if (query) {
            this.filteredProducts = this.products.filter((product) => {
              // 檢查產品名稱是否包含搜尋關鍵字
              const matchesName = product?.name
                .toLowerCase()
                .includes(query.toLowerCase());

              // 檢查產品的任意規格是否包含搜尋關鍵字
              const matchesSpecs = product.specs.some((spec) =>
                spec?.name.toLowerCase().includes(query.toLowerCase())
              );

              // 只要名稱或規格匹配就返回 true
              return matchesName || matchesSpecs;
            });
          } else {
            this.filteredProducts = this.products;
          }
        },
      });
      app.component("header-component", HeaderComponent);
      app.component("footer-component", FooterComponent);

      app.mount("#app");
    </script>
  </body>
</html>
