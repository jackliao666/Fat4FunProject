@model FAT4FUN.BackEnd.Site.Models.ViewModels.ChangePasswordVm

@{
    ViewBag.Title = "ChangePassword";
}

@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "changePasswordForm" }))
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        <h4>變更密碼</h4>
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        @Html.HiddenFor(model => model.Id)

        <div class="mb-3 col-md-8">
            @Html.LabelFor(model => model.Password, htmlAttributes: new { @class = "form-label col-md-2" })
            @Html.EditorFor(model => model.Password, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.Password, "", new { @class = "text-danger" })
        </div>

        <div class="mb-3 col-md-8">
            @Html.LabelFor(model => model.NewPassword, htmlAttributes: new { @class = "form-label col-md-2" })
            @Html.EditorFor(model => model.NewPassword, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.NewPassword, "", new { @class = "text-danger" })
        </div>

        <div class="mb-3 col-md-8">
            @Html.LabelFor(model => model.ConfirmPassword, htmlAttributes: new { @class = "form-label col-md-2" })
            @Html.EditorFor(model => model.ConfirmPassword, new { htmlAttributes = new { @class = "form-control" } })
            @Html.ValidationMessageFor(model => model.ConfirmPassword, "", new { @class = "text-danger" })
        </div>

        <div class="mb-3 col-md-6">
            <input type="submit" value="更新" class="btn btn-primary" />
        </div>
    </div>
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
    $(document).ready(function () {
        $('#changePasswordForm').submit(function (event) {
            event.preventDefault(); // 防止表單自動提交

            $.ajax({
                url: '@Url.Action("ChangePasswordAlert", "Users")', // 將 Action 名稱改成新的 ChangePasswordAlert
                type: 'POST',
                data: $(this).serialize(),
                success: function (response) {
                    console.log("成功返回的响应:", response); // 查看成功回调的响应
                    if (response.success) {
                        Swal.fire({
                            title: "密碼變更成功",
                            text: "您的密碼已成功更新，將返回首頁。",
                            icon: "success",
                            confirmButtonText: "確定"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // 使用 SweetAlert 的 promise 來確保提示顯示後再進行跳轉
                                window.location.href = '@Url.Action("Index", "Home")';
                            }
                        });
                    } else {
                        Swal.fire({
                            title: "密碼變更失敗",
                            text: response.message || "請再試一次。",
                            icon: "error",
                            confirmButtonText: "確定"
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.log("錯誤詳細信息:", xhr.responseText, status, error); // 查看具體錯誤信息
                    Swal.fire({
                        title: "發生錯誤",
                        text: "請稍後重試。",
                        icon: "error",
                        confirmButtonText: "確定"
                    });
                }
            });
        });
    });
    </script>
}