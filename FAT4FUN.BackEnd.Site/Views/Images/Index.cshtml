@model FAT4FUN.BackEnd.Site.Models.ViewModels.ImageVm

<h2>圖片管理</h2>



<div>
    <!-- 產品下拉選單 -->
    <select id="productSelect">
        @foreach (var product in Model.Products)
        {
            <option value="@product.Value">@product.Text</option>
        }
    </select>
</div>


<!-- 圖片顯示區域 -->
<div id="imageContainer">
    @foreach (var image in Model.Images)
    {
        <img src="@Url.Content(image.Path)" alt="Image for product @Model.SelectedProductId" class="product-image" />
    }
</div>


<!-- 產品選擇 -->
@*<form id="productForm" method="get" action="@Url.Action("Index", "Images")">
    <label for="productSelect">选择产品：</label>
    <select id="productSelect" name="productId" onchange="this.form.submit();">
        @foreach (var product in Model.Products)
        {
            <option value="@product.Value" @(Model.SelectedProductId == int.Parse(product.Value) ? "selected" : "")>
                @product.Text
            </option>
        }
    </select>
</form>*@

<!-- 圖片列表展示 -->
@*<h3>產品圖片</h3>
<div id="imageList">
    @if (Model.Images != null && Model.Images.Any())
    {
        <ul>
            @foreach (var image in Model.Images)
            {
                <li>
                    <img src="@image.Path" alt="Product Image" style="width:100px;height:100px;" />
                    <p>排序：@image.Sort</p>
                    
                </li>
            }
        </ul>
    }
    else
    {
        <p>沒有圖片可顯示。</p>
    }
</div>*@

<!-- 圖片上傳 -->
<h3>上傳新圖片</h3>
<form id="uploadForm" enctype="multipart/form-data">
    <input type="hidden" id="productId" name="productId" value="@Model.SelectedProductId" />
    <input type="number" id="sort" name="sort" placeholder="排序" />
    <input type="file" id="file" name="file" />
    <button type="submit">上傳圖片</button>
</form>

<!-- 使用 jQuery 處理上傳 -->
@section scripts {
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
    // 從 localStorage 中讀取選中的 productId
    var selectedProductId = localStorage.getItem('selectedProductId');

    if (selectedProductId) {
        $('#productSelect').val(selectedProductId); // 設置選中項
        $('#productId').val(selectedProductId); // 更新隱藏字段

        // 自動加載選中的產品的圖片
        $.ajax({
            url: '@Url.Action("GetProductImages", "Images")',
            type: 'GET',
            data: { productId: selectedProductId },
            success: function (response) {
                if (response.success) {
                    $('#imageContainer').empty();
                    response.images.forEach(function (image) {
                        $('#imageContainer').append('<img src="' + image.Path + '" class="product-image" alt="Product Image" />');
                    });
                } else {
                    alert(response.message);
                }
            },
            error: function () {
                alert("無法加載圖片，請稍後再試。");
            }
        });
    }
        $('#uploadForm').submit(function (e) {
            e.preventDefault(); // 阻止表單的默認提交行為

            var formData = new FormData(this);

            $.ajax({
                url: '@Url.Action("UploadImage", "Images")',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    if (response.success) {
                        alert('圖片上傳成功，路徑為：' + response.path);

                        window.location.href = '@Url.Action("Index", "Images")' + '?productId=' + productId;
                        /*location.reload();*/
                    } else {
                        alert('圖片上傳失敗：' + response.message);
                    }
                },
                error: function () {
                    alert('上傳圖片時出錯。');
                }
            });
        });
    });
    </script>


    <script type="text/javascript">
    $(document).ready(function () {
        // 當下拉框改變時，發送請求獲取對應產品的圖片
        $('#productSelect').change(function () {
            var productId = $(this).val();
            $('#productId').val(productId);
            localStorage.setItem('selectedProductId', productId);

            // 發送 AJAX 請求
            $.ajax({
                url: '@Url.Action("GetProductImages", "Images")', // 後端方法URL
                type: 'GET',
                data: { productId: productId },
                success: function (response) {
                    if (response.success) {
                        // 清空舊的圖片
                        $('#imageContainer').empty();

                        // 添加新的圖片
                        response.images.forEach(function (image) {
                            $('#imageContainer').append('<img src="' + image.Path + '" class="product-image" alt="Product Image" />');
                        });
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert("無法加載圖片，請稍後再試。");
                }
            });
        });
    });
    </script>
}